<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Gerenciamento de Usu치rios</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .admin-header h1 {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--cor-texto);
        }
        
        .admin-header h1 i {
            color: var(--cor-secundaria);
        }
        
        .admin-header-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn-primary, .btn-secondary {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--cor-secundaria), #2980b9);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn-secondary {
            background: var(--cor-fundo-secundario);
            color: var(--cor-texto);
            border: 1px solid var(--cor-borda);
        }
        
        .btn-secondary:hover {
            background: var(--cor-borda);
            transform: translateY(-2px);
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 13px;
            border-radius: 6px;
        }
        
        .btn-icone {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--cor-fundo-secundario);
            border: 1px solid var(--cor-borda);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-icone:hover {
            transform: translateY(-2px);
            box-shadow: var(--sombra);
        }
        
        .btn-icone.editar:hover { 
            background: #3498db; 
            color: white; 
            border-color: #3498db;
        }
        
        .btn-icone.excluir:hover { 
            background: #e74c3c; 
            color: white;
            border-color: #e74c3c;
        }
        
        .btn-icone.bloquear:hover { 
            background: #f39c12; 
            color: white;
            border-color: #f39c12;
        }
        
        .btn-icone:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-icone:disabled:hover {
            transform: none;
            background: var(--cor-fundo-secundario);
            color: inherit;
        }
        
        /* Filtros */
        .filtros-usuarios {
            background: var(--cor-card);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: var(--sombra);
            border: 1px solid var(--cor-borda);
        }
        
        .filtros-usuarios h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            color: var(--cor-texto);
            font-size: 18px;
        }
        
        .filtros-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .filtro-group {
            flex: 1;
            min-width: 200px;
        }
        
        .filtro-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
            font-weight: 500;
            color: var(--cor-texto-secundario);
        }
        
        .filtro-group select,
        .filtro-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--cor-borda);
            border-radius: 5px;
            background: var(--cor-fundo);
            color: var(--cor-texto);
            font-size: 14px;
        }
        
        .filtro-group select:focus,
        .filtro-group input:focus {
            outline: none;
            border-color: var(--cor-secundaria);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .acoes-em-lote {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
            padding-top: 20px;
            border-top: 1px solid var(--cor-borda);
        }
        
        /* Grid de Usu치rios */
        .usuarios-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .usuario-card {
            background: var(--cor-card);
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--sombra);
            border-left: 5px solid #3498db;
            transition: all 0.3s;
            border: 1px solid var(--cor-borda);
            position: relative;
            overflow: hidden;
        }
        
        .usuario-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--sombra-forte);
        }
        
        .usuario-card.administrador { border-left-color: #e74c3c; }
        .usuario-card.engenharia { border-left-color: #2ecc71; }
        .usuario-card.supervisor { border-left-color: #f39c12; }
        .usuario-card.manutencao { border-left-color: #9b59b6; }
        .usuario-card.operador { border-left-color: #3498db; }
        
        .usuario-card.system-admin {
            background: linear-gradient(135deg, var(--cor-card), rgba(142, 68, 173, 0.1));
            border: 2px solid #8e44ad;
        }
        
        .usuario-card.system-admin::before {
            content: '游댫 ADMIN DO SISTEMA';
            position: absolute;
            top: 10px;
            right: -30px;
            background: #8e44ad;
            color: white;
            padding: 5px 30px;
            font-size: 11px;
            font-weight: bold;
            transform: rotate(45deg);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1;
        }
        
        .usuario-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .usuario-info-header {
            flex: 1;
        }
        
        .usuario-info-header h4 {
            font-size: 18px;
            margin-bottom: 5px;
            color: var(--cor-texto);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .usuario-info-header h4 i {
            font-size: 16px;
            color: var(--cor-secundaria);
        }
        
        .usuario-acoes {
            display: flex;
            gap: 8px;
        }
        
        .usuario-info {
            margin-bottom: 15px;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--cor-texto);
        }
        
        .info-item i {
            width: 16px;
            color: var(--cor-secundaria);
        }
        
        .badge-nivel {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            color: white;
            margin-left: 5px;
        }
        
        .badge-ativo {
            background: #2ecc71;
        }
        
        .badge-inativo {
            background: #95a5a6;
        }
        
        .badge-system {
            background: #8e44ad;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .usuario-metadata {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--cor-borda);
            font-size: 12px;
            color: var(--cor-texto-secundario);
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .usuario-metadata span {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Barra de estat칤sticas */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            background: var(--cor-card);
            padding: 20px;
            border-radius: 10px;
            box-shadow: var(--sombra);
            border: 1px solid var(--cor-borda);
            margin-top: 30px;
        }
        
        .stat {
            text-align: center;
            padding: 15px;
            background: var(--cor-fundo-secundario);
            border-radius: 8px;
            transition: transform 0.3s;
        }
        
        .stat:hover {
            transform: translateY(-3px);
        }
        
        .stat-value {
            display: block;
            font-size: 32px;
            font-weight: 700;
            color: var(--cor-secundaria);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 13px;
            color: var(--cor-texto-secundario);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
        }
        
        .modal.active {
            display: flex;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: var(--cor-card);
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.3s;
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--cor-borda);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--cor-card);
            z-index: 10;
        }
        
        .modal-header h3 {
            color: var(--cor-texto);
            font-size: 20px;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .close-modal {
            font-size: 28px;
            cursor: pointer;
            color: var(--cor-texto-secundario);
            transition: color 0.3s;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .close-modal:hover {
            color: var(--cor-erro);
            background: rgba(231, 76, 60, 0.1);
        }
        
        .modal-body {
            padding: 25px;
        }
        
        /* Formul치rio */
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            flex: 1;
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--cor-texto);
            font-size: 14px;
        }
        
        .form-group label i {
            margin-right: 5px;
            color: var(--cor-secundaria);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--cor-borda);
            border-radius: 5px;
            background: var(--cor-fundo);
            color: var(--cor-texto);
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--cor-secundaria);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .form-group input:disabled,
        .form-group select:disabled {
            background: var(--cor-fundo-secundario);
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .form-group input[readonly] {
            background: var(--cor-fundo-secundario);
            cursor: default;
        }
        
        .form-group .input-hint {
            font-size: 12px;
            color: var(--cor-texto-secundario);
            margin-top: 5px;
        }
        
        /* For칞a da senha */
        .senha-strength {
            margin-top: 10px;
        }
        
        .strength-bar {
            height: 5px;
            background: var(--cor-fundo-secundario);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 5px;
        }
        
        .strength-fill {
            height: 100%;
            width: 0%;
            transition: width 0.3s, background-color 0.3s;
        }
        
        .strength-text {
            font-size: 12px;
            color: var(--cor-texto-secundario);
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--cor-borda);
        }
        
        /* Loading */
        .loading {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 20px;
            color: var(--cor-texto-secundario);
        }
        
        .loading i {
            font-size: 40px;
            color: var(--cor-secundaria);
            margin-bottom: 15px;
        }
        
        /* Sem resultados */
        .no-results {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 20px;
            color: var(--cor-texto-secundario);
        }
        
        .no-results i {
            font-size: 60px;
            margin-bottom: 20px;
            color: var(--cor-borda);
        }
        
        .no-results h3 {
            margin-bottom: 10px;
            color: var(--cor-texto);
        }
        
        /* Mensagem flutuante */
        .mensagem-flutuante {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            background: var(--cor-card);
            box-shadow: var(--sombra-forte);
            z-index: 10000;
            transform: translateX(120%);
            transition: transform 0.3s ease;
            min-width: 300px;
            max-width: 400px;
            border-left: 4px solid var(--cor-info);
        }
        
        .mensagem-flutuante.show {
            transform: translateX(0);
        }
        
        .mensagem-flutuante.success { border-left-color: #2ecc71; }
        .mensagem-flutuante.error { border-left-color: #e74c3c; }
        .mensagem-flutuante.warning { border-left-color: #f39c12; }
        .mensagem-flutuante.info { border-left-color: #3498db; }
        
        .mensagem-conteudo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .mensagem-conteudo i {
            font-size: 20px;
        }
        
        .mensagem-flutuante.success i { color: #2ecc71; }
        .mensagem-flutuante.error i { color: #e74c3c; }
        .mensagem-flutuante.warning i { color: #f39c12; }
        .mensagem-flutuante.info i { color: #3498db; }
        
        /* Tooltips */
        [title] {
            position: relative;
            cursor: help;
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            .admin-container {
                padding: 15px;
            }
            
            .admin-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .admin-header-buttons {
                flex-direction: column;
            }
            
            .filtros-row {
                flex-direction: column;
            }
            
            .filtro-group {
                min-width: 100%;
            }
            
            .acoes-em-lote {
                flex-direction: column;
            }
            
            .usuarios-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-bar {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .modal-content {
                width: 95%;
                margin: 10px;
            }
            
            .usuario-card.system-admin::before {
                font-size: 9px;
                padding: 4px 25px;
                right: -35px;
            }
        }
        
        @media (max-width: 480px) {
            .admin-header h1 {
                font-size: 20px;
            }
            
            .btn-primary, .btn-secondary {
                padding: 10px 16px;
                font-size: 13px;
            }
            
            .usuario-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .usuario-acoes {
                justify-content: flex-end;
            }
            
            .stat-value {
                font-size: 24px;
            }
        }
        
        /* Anima칞칫es */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <script>
        // Verificar se 칠 administrador
        (function() {
            const nivel = localStorage.getItem('gestao_equipamentos_nivel');
            if (nivel !== 'administrador') {
                alert('Acesso negado. Apenas administradores podem acessar esta p치gina.');
                window.location.href = 'index.html';
            }
        })();
    </script>
    
    <div class="admin-container">
        <div class="admin-header">
            <h1>
                <i class="fas fa-users-cog"></i> 
                Gerenciamento de Usu치rios
            </h1>
            <div class="admin-header-buttons">
                <button onclick="window.location.href='index.html'" class="btn-secondary">
                    <i class="fas fa-arrow-left"></i> Voltar
                </button>
                <button onclick="gerenciador.abrirModalNovoUsuario()" class="btn-primary">
                    <i class="fas fa-user-plus"></i> Novo Usu치rio
                </button>
            </div>
        </div>
        
        <!-- Filtros -->
        <div class="filtros-usuarios">
            <h3><i class="fas fa-filter"></i> Filtros</h3>
            <div class="filtros-row">
                <div class="filtro-group">
                    <label for="filtro-nivel">
                        <i class="fas fa-tag"></i> N칤vel de Acesso:
                    </label>
                    <select id="filtro-nivel">
                        <option value="all">Todos os n칤veis</option>
                        <option value="administrador">Administrador</option>
                        <option value="engenharia">Engenharia</option>
                        <option value="supervisor">Supervisor</option>
                        <option value="manutencao">Manuten칞칚o</option>
                        <option value="operador">Operador</option>
                    </select>
                </div>
                
                <div class="filtro-group">
                    <label for="filtro-status">
                        <i class="fas fa-circle"></i> Status:
                    </label>
                    <select id="filtro-status">
                        <option value="all">Todos</option>
                        <option value="ativo">Ativos</option>
                        <option value="inativo">Inativos</option>
                    </select>
                </div>
                
                <div class="filtro-group">
                    <label for="filtro-busca">
                        <i class="fas fa-search"></i> Buscar:
                    </label>
                    <input type="text" id="filtro-busca" placeholder="Nome, usu치rio ou e-mail...">
                </div>
                
                <div class="filtro-group">
                    <label style="visibility: hidden;">.</label>
                    <button onclick="gerenciador.aplicarFiltros()" class="btn-secondary">
                        <i class="fas fa-search"></i> Filtrar
                    </button>
                </div>
            </div>
            
            <div class="acoes-em-lote">
                <button onclick="gerenciador.exportarUsuarios()" class="btn-small btn-secondary">
                    <i class="fas fa-file-export"></i> Exportar Lista
                </button>
                <button onclick="gerenciador.reenviarSenhas()" class="btn-small btn-secondary">
                    <i class="fas fa-envelope"></i> Reenviar Acesso
                </button>
                <button onclick="gerenciador.recarregarUsuarios()" class="btn-small btn-secondary">
                    <i class="fas fa-sync-alt"></i> Recarregar
                </button>
            </div>
        </div>
        
        <!-- Grid de Usu치rios -->
        <div class="usuarios-grid" id="usuarios-container">
            <!-- Usu치rios ser칚o carregados aqui -->
            <div class="loading">
                <i class="fas fa-cog fa-spin"></i>
                <p>Carregando usu치rios...</p>
            </div>
        </div>
        
        <!-- Estat칤sticas -->
        <div class="stats-bar">
            <div class="stat">
                <span class="stat-value" id="total-usuarios">0</span>
                <span class="stat-label">
                    <i class="fas fa-users"></i> Total de Usu치rios
                </span>
            </div>
            <div class="stat">
                <span class="stat-value" id="usuarios-ativos">0</span>
                <span class="stat-label">
                    <i class="fas fa-user-check"></i> Usu치rios Ativos
                </span>
            </div>
            <div class="stat">
                <span class="stat-value" id="usuarios-inativos">0</span>
                <span class="stat-label">
                    <i class="fas fa-user-slash"></i> Usu치rios Inativos
                </span>
            </div>
            <div class="stat">
                <span class="stat-value" id="admins-total">0</span>
                <span class="stat-label">
                    <i class="fas fa-user-shield"></i> Administradores
                </span>
            </div>
        </div>
    </div>
    
    <!-- Modal Novo/Editar Usu치rio -->
    <div id="modal-usuario" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-usuario-titulo">
                    <i class="fas fa-user-plus"></i> 
                    <span>Novo Usu치rio</span>
                </h3>
                <span class="close-modal" onclick="gerenciador.fecharModalUsuario()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="form-usuario" onsubmit="gerenciador.salvarUsuario(event)">
                    <input type="hidden" id="usuario-id">
                    <input type="hidden" id="usuario-is-system-admin" value="false">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="usuario-nome">
                                <i class="fas fa-user"></i> Nome Completo *
                            </label>
                            <input type="text" id="usuario-nome" required 
                                   placeholder="Ex: Jo칚o da Silva"
                                   maxlength="100">
                        </div>
                        <div class="form-group">
                            <label for="usuario-username">
                                <i class="fas fa-at"></i> Nome de Usu치rio *
                            </label>
                            <input type="text" id="usuario-username" required 
                                   pattern="[a-z0-9_]+" 
                                   title="Apenas letras min칰sculas, n칰meros e underscore"
                                   placeholder="Ex: joao.silva"
                                   maxlength="30">
                            <div class="input-hint">Apenas letras min칰sculas, n칰meros e _</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="usuario-email">
                                <i class="fas fa-envelope"></i> E-mail *
                            </label>
                            <input type="email" id="usuario-email" required 
                                   placeholder="Ex: joao@empresa.com"
                                   maxlength="100">
                        </div>
                        <div class="form-group">
                            <label for="usuario-departamento">
                                <i class="fas fa-building"></i> Departamento
                            </label>
                            <input type="text" id="usuario-departamento" 
                                   placeholder="Ex: TI, Opera칞칫es..."
                                   maxlength="50">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="usuario-nivel">
                                <i class="fas fa-tag"></i> N칤vel de Acesso *
                            </label>
                            <select id="usuario-nivel" required>
                                <option value="">Selecione...</option>
                                <option value="operador">Operador</option>
                                <option value="supervisor">Supervisor</option>
                                <option value="manutencao">Manuten칞칚o</option>
                                <option value="engenharia">Engenharia</option>
                                <option value="administrador">Administrador</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="usuario-status">
                                <i class="fas fa-toggle-on"></i> Status
                            </label>
                            <select id="usuario-status">
                                <option value="ativo">Ativo</option>
                                <option value="inativo">Inativo</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="usuario-senha">
                                <i class="fas fa-lock"></i> Senha *
                            </label>
                            <input type="password" id="usuario-senha" 
                                   minlength="6" 
                                   title="M칤nimo 6 caracteres"
                                   placeholder="M칤nimo 6 caracteres">
                            <div class="input-hint" id="senha-hint">M칤nimo 6 caracteres</div>
                        </div>
                        <div class="form-group">
                            <label for="usuario-confirmar-senha">
                                <i class="fas fa-lock"></i> Confirmar Senha *
                            </label>
                            <input type="password" id="usuario-confirmar-senha"
                                   placeholder="Digite a senha novamente">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>For칞a da Senha:</label>
                        <div class="senha-strength">
                            <div class="strength-bar">
                                <div class="strength-fill" id="senha-strength-bar"></div>
                            </div>
                            <span class="strength-text" id="senha-strength-text">Fraca</span>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="gerenciador.fecharModalUsuario()">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="submit" class="btn-primary" id="btn-salvar-usuario">
                            <i class="fas fa-save"></i> <span>Salvar Usu치rio</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal de Confirma칞칚o -->
    <div id="modal-confirmacao" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 id="modal-confirmacao-titulo">
                    <i class="fas fa-question-circle"></i> Confirmar A칞칚o
                </h3>
                <span class="close-modal" onclick="gerenciador.fecharModalConfirmacao()">&times;</span>
            </div>
            <div class="modal-body">
                <p id="modal-confirmacao-mensagem" style="margin-bottom: 20px;"></p>
                <div class="form-actions">
                    <button class="btn-secondary" onclick="gerenciador.fecharModalConfirmacao()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button class="btn-primary" id="modal-confirmacao-confirmar">
                        <i class="fas fa-check"></i> Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // ===========================================
        // GERENCIADOR DE USU츼RIOS
        // ===========================================

        class GerenciadorUsuarios {
            constructor() {
                this.usuarios = [];
                this.usuarioEditando = null;
                this.nextUserId = 1;
                this.filtros = {
                    nivel: 'all',
                    status: 'all',
                    busca: ''
                };
                this.modalConfirmacaoCallback = null;
                this.init();
            }
            
            async init() {
                // Verificar permiss칚o
                if (!this.verificarPermissaoAdmin()) return;
                
                // Carregar usu치rios
                await this.carregarUsuarios();
                
                // Configurar eventos
                this.configurarEventos();
                
                // Renderizar interface
                this.renderizarUsuarios();
                this.atualizarEstatisticas();
            }
            
            verificarPermissaoAdmin() {
                const nivel = localStorage.getItem('gestao_equipamentos_nivel');
                const isSystemAdmin = localStorage.getItem('gestao_equipamentos_is_system_admin') === 'true';
                
                if (nivel !== 'administrador') {
                    alert('Acesso negado. Apenas administradores.');
                    window.location.href = 'index.html';
                    return false;
                }
                
                // Adicionar badge de admin do sistema se for
                if (isSystemAdmin) {
                    console.log('Bem-vindo, Administrador do Sistema');
                }
                
                return true;
            }
            
            async carregarUsuarios() {
                try {
                    // Mostrar loading
                    this.mostrarLoading(true);
                    
                    // Usar o bin espec칤fico para usu치rios
                    const response = await fetch(
                        `${JSONBIN_CONFIG.BIN_USUARIOS.BASE_URL}/${JSONBIN_CONFIG.BIN_USUARIOS.ID}/latest`,
                        { headers: JSONBIN_CONFIG.headers }
                    );
                    
                    if (!response.ok) throw new Error('Erro ao carregar usu치rios');
                    
                    const result = await response.json();
                    
                    if (result.record && result.record.usuarios) {
                        this.usuarios = result.record.usuarios;
                        this.nextUserId = result.record.nextUserId || 
                                         (this.usuarios.length > 0 ? 
                                          Math.max(...this.usuarios.map(u => u.id)) + 1 : 1);
                        
                        this.mostrarMensagem('Usu치rios carregados com sucesso', 'success');
                    } else {
                        // Dados iniciais se o bin estiver vazio - usar array do config.js
                        this.usuarios = window.USUARIOS_AUTORIZADOS || [
                            {
                                id: 1,
                                username: 'administrador',
                                senha: 'admin789',
                                nivel: 'administrador',
                                nome: 'Administrador Sistema',
                                email: 'admin@empresa.com',
                                departamento: 'TI',
                                ativo: true,
                                isSystemAdmin: true,
                                dataCriacao: new Date().toISOString().split('T')[0],
                                criadoPor: 'sistema'
                            }
                        ];
                        this.nextUserId = Math.max(...this.usuarios.map(u => u.id)) + 1;
                        
                        // Salvar dados iniciais
                        await this.salvarUsuarios();
                    }
                    
                } catch (error) {
                    console.error('Erro ao carregar usu치rios:', error);
                    
                    // Fallback para dados locais
                    this.usuarios = window.USUARIOS_AUTORIZADOS || [];
                    this.nextUserId = this.usuarios.length > 0 ? 
                                     Math.max(...this.usuarios.map(u => u.id)) + 1 : 1;
                    
                    this.mostrarMensagem('Usando dados locais (offline)', 'warning');
                } finally {
                    this.mostrarLoading(false);
                }
            }
            
            async recarregarUsuarios() {
                await this.carregarUsuarios();
                this.renderizarUsuarios();
                this.atualizarEstatisticas();
            }
            
            async salvarUsuarios() {
                try {
                    const data = {
                        usuarios: this.usuarios,
                        nextUserId: this.nextUserId,
                        ultimaAtualizacao: new Date().toISOString(),
                        atualizadoPor: localStorage.getItem('gestao_equipamentos_usuario') || 'sistema'
                    };
                    
                    const response = await fetch(
                        `${JSONBIN_CONFIG.BIN_USUARIOS.BASE_URL}/${JSONBIN_CONFIG.BIN_USUARIOS.ID}`,
                        {
                            method: 'PUT',
                            headers: JSONBIN_CONFIG.headers,
                            body: JSON.stringify(data)
                        }
                    );
                    
                    if (!response.ok) throw new Error('Erro ao salvar usu치rios');
                    
                    // Registrar atividade
                    this.registrarAtividade('SALVAR_USUARIOS', 'Dados de usu치rios salvos');
                    
                    return true;
                } catch (error) {
                    console.error('Erro ao salvar usu치rios:', error);
                    this.mostrarMensagem('Erro ao salvar usu치rios no servidor', 'error');
                    return false;
                }
            }
            
            configurarEventos() {
                // Eventos de filtro
                document.getElementById('filtro-nivel').addEventListener('change', (e) => {
                    this.filtros.nivel = e.target.value;
                    this.renderizarUsuarios();
                });
                
                document.getElementById('filtro-status').addEventListener('change', (e) => {
                    this.filtros.status = e.target.value;
                    this.renderizarUsuarios();
                });
                
                document.getElementById('filtro-busca').addEventListener('input', (e) => {
                    this.filtros.busca = e.target.value.toLowerCase();
                    this.renderizarUsuarios();
                });
                
                // Valida칞칚o de senha em tempo real
                document.getElementById('usuario-senha')?.addEventListener('input', (e) => {
                    this.validarForcaSenha(e.target.value);
                    this.validarConfirmacaoSenha();
                });
                
                document.getElementById('usuario-confirmar-senha')?.addEventListener('input', () => {
                    this.validarConfirmacaoSenha();
                });
            }
            
            filtrarUsuarios() {
                return this.usuarios.filter(usuario => {
                    // Filtrar por n칤vel
                    if (this.filtros.nivel !== 'all' && usuario.nivel !== this.filtros.nivel) {
                        return false;
                    }
                    
                    // Filtrar por status
                    if (this.filtros.status !== 'all') {
                        const isAtivo = usuario.ativo === true || usuario.ativo === undefined;
                        if (this.filtros.status === 'ativo' && !isAtivo) return false;
                        if (this.filtros.status === 'inativo' && isAtivo) return false;
                    }
                    
                    // Filtrar por busca
                    if (this.filtros.busca) {
                        const busca = this.filtros.busca;
                        const nomeMatch = usuario.nome?.toLowerCase().includes(busca) || false;
                        const usernameMatch = usuario.username?.toLowerCase().includes(busca) || false;
                        const emailMatch = usuario.email?.toLowerCase().includes(busca) || false;
                        
                        if (!nomeMatch && !usernameMatch && !emailMatch) {
                            return false;
                        }
                    }
                    
                    return true;
                });
            }
            
            renderizarUsuarios() {
                const container = document.getElementById('usuarios-container');
                const usuariosFiltrados = this.filtrarUsuarios();
                
                if (usuariosFiltrados.length === 0) {
                    container.innerHTML = `
                        <div class="no-results">
                            <i class="fas fa-user-slash"></i>
                            <h3>Nenhum usu치rio encontrado</h3>
                            <p>Tente ajustar os filtros de busca</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = usuariosFiltrados.map(usuario => {
                    const nivelInfo = this.getNivelInfo(usuario.nivel);
                    const isAtivo = usuario.ativo === true || usuario.ativo === undefined;
                    const isSystemAdmin = usuario.isSystemAdmin === true;
                    
                    // Determinar classes do card
                    let cardClasses = `usuario-card ${usuario.nivel}`;
                    if (isSystemAdmin) cardClasses += ' system-admin';
                    
                    // Formatar datas
                    const dataCriacao = this.formatarData(usuario.dataCriacao);
                    const ultimoAcesso = usuario.ultimoAcesso ? this.formatarDataHora(usuario.ultimoAcesso) : 'Nunca';
                    
                    return `
                        <div class="${cardClasses}">
                            <div class="usuario-header">
                                <div class="usuario-info-header">
                                    <h4>
                                        <i class="fas ${nivelInfo.icone}" style="color: ${nivelInfo.cor};"></i>
                                        ${this.escapeHTML(usuario.nome)}
                                        ${isSystemAdmin ? '<span class="badge-system"><i class="fas fa-shield-alt"></i> SISTEMA</span>' : ''}
                                    </h4>
                                    <div class="info-item">
                                        <i class="fas fa-tag" style="color: ${nivelInfo.cor};"></i>
                                        <span>${nivelInfo.nome}</span>
                                        <span class="badge-nivel ${isAtivo ? 'badge-ativo' : 'badge-inativo'}">
                                            ${isAtivo ? 'Ativo' : 'Inativo'}
                                        </span>
                                    </div>
                                </div>
                                <div class="usuario-acoes">
                                    <button class="btn-icone editar" onclick="gerenciador.editarUsuario(${usuario.id})" 
                                            title="${isSystemAdmin ? 'Administrador do sistema - edi칞칚o limitada' : 'Editar usu치rio'}"
                                            ${isSystemAdmin && !this.isCurrentUserSystemAdmin() ? 'disabled' : ''}>
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn-icone bloquear" onclick="gerenciador.toggleStatusUsuario(${usuario.id})" 
                                            title="${isAtivo ? 'Desativar usu치rio' : 'Ativar usu치rio'}"
                                            ${isSystemAdmin ? 'disabled' : ''}>
                                        <i class="fas ${isAtivo ? 'fa-user-slash' : 'fa-user-check'}"></i>
                                    </button>
                                    <button class="btn-icone excluir" onclick="gerenciador.excluirUsuario(${usuario.id})" 
                                            title="Excluir usu치rio"
                                            ${isSystemAdmin ? 'disabled' : ''}>
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="usuario-info">
                                <div class="info-item">
                                    <i class="fas fa-user"></i>
                                    <strong>Usu치rio:</strong> ${this.escapeHTML(usuario.username)}
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-envelope"></i>
                                    <strong>E-mail:</strong> ${this.escapeHTML(usuario.email || 'N칚o informado')}
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-building"></i>
                                    <strong>Departamento:</strong> ${this.escapeHTML(usuario.departamento || 'N칚o informado')}
                                </div>
                            </div>
                            
                            <div class="usuario-metadata">
                                <span title="Data de cria칞칚o">
                                    <i class="fas fa-calendar-plus"></i> ${dataCriacao}
                                </span>
                                <span title="칔ltimo acesso">
                                    <i class="fas fa-clock"></i> ${ultimoAcesso}
                                </span>
                                <span title="Criado por">
                                    <i class="fas fa-user-cog"></i> ${this.escapeHTML(usuario.criadoPor || 'sistema')}
                                </span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            atualizarEstatisticas() {
                const totalUsuarios = this.usuarios.length;
                const usuariosAtivos = this.usuarios.filter(u => u.ativo === true || u.ativo === undefined).length;
                const usuariosInativos = this.usuarios.filter(u => u.ativo === false).length;
                const adminsTotal = this.usuarios.filter(u => u.nivel === 'administrador').length;
                
                document.getElementById('total-usuarios').textContent = totalUsuarios;
                document.getElementById('usuarios-ativos').textContent = usuariosAtivos;
                document.getElementById('usuarios-inativos').textContent = usuariosInativos;
                document.getElementById('admins-total').textContent = adminsTotal;
            }
            
            async salvarUsuario(event) {
                event.preventDefault();
                
                const form = document.getElementById('form-usuario');
                const usuarioId = document.getElementById('usuario-id').value;
                const isEdit = !!usuarioId;
                
                // Validar senhas
                const senha = document.getElementById('usuario-senha').value;
                const confirmarSenha = document.getElementById('usuario-confirmar-senha').value;
                const isSystemAdmin = document.getElementById('usuario-is-system-admin').value === 'true';
                
                // Valida칞칚o de senha para novo usu치rio ou se senha foi fornecida na edi칞칚o
                if (!isEdit || senha) {
                    if (!senha || !confirmarSenha) {
                        this.mostrarMensagem('Preencha os campos de senha', 'error');
                        return;
                    }
                    
                    if (senha !== confirmarSenha) {
                        this.mostrarMensagem('As senhas n칚o coincidem', 'error');
                        return;
                    }
                    
                    if (senha.length < 6) {
                        this.mostrarMensagem('A senha deve ter no m칤nimo 6 caracteres', 'error');
                        return;
                    }
                    
                    // Verificar for칞a da senha
                    const forcaSenha = this.validarForcaSenha(senha);
                    if (forcaSenha.nivel === 'fraca' && senha.length > 0) {
                        const confirmar = await this.mostrarConfirmacao(
                            'Senha Fraca',
                            'A senha 칠 considerada fraca. Deseja continuar mesmo assim?'
                        );
                        if (!confirmar) return;
                    }
                }
                
                const usuario = {
                    username: document.getElementById('usuario-username').value.trim().toLowerCase(),
                    nome: document.getElementById('usuario-nome').value.trim(),
                    email: document.getElementById('usuario-email').value.trim().toLowerCase(),
                    departamento: document.getElementById('usuario-departamento').value.trim(),
                    nivel: document.getElementById('usuario-nivel').value,
                    ativo: document.getElementById('usuario-status').value === 'ativo'
                };
                
                // Valida칞칫es
                if (!usuario.username || !usuario.nome || !usuario.email || !usuario.nivel) {
                    this.mostrarMensagem('Preencha todos os campos obrigat칩rios', 'error');
                    return;
                }
                
                // Validar formato do username
                if (!/^[a-z0-9_]+$/.test(usuario.username)) {
                    this.mostrarMensagem('Nome de usu치rio deve conter apenas letras min칰sculas, n칰meros e underscore', 'error');
                    return;
                }
                
                // Validar email
                if (!this.validarEmail(usuario.email)) {
                    this.mostrarMensagem('E-mail inv치lido', 'error');
                    return;
                }
                
                if (isEdit) {
                    // Editar usu치rio existente
                    const index = this.usuarios.findIndex(u => u.id === parseInt(usuarioId));
                    if (index !== -1) {
                        // Verificar se 칠 admin do sistema e se o usu치rio atual pode editar
                        if (this.usuarios[index].isSystemAdmin && !this.isCurrentUserSystemAdmin()) {
                            this.mostrarMensagem('Voc칡 n칚o tem permiss칚o para editar o administrador do sistema', 'error');
                            return;
                        }
                        
                        // Verificar se username j치 existe (exceto para o mesmo usu치rio)
                        const usernameExistente = this.usuarios.find(u => 
                            u.username.toLowerCase() === usuario.username.toLowerCase() && 
                            u.id !== parseInt(usuarioId)
                        );
                        if (usernameExistente) {
                            this.mostrarMensagem('Nome de usu치rio j치 existe', 'error');
                            return;
                        }
                        
                        // Verificar se email j치 existe (exceto para o mesmo usu치rio)
                        const emailExistente = this.usuarios.find(u => 
                            u.email.toLowerCase() === usuario.email.toLowerCase() && 
                            u.id !== parseInt(usuarioId)
                        );
                        if (emailExistente) {
                            this.mostrarMensagem('E-mail j치 est치 em uso', 'error');
                            return;
                        }
                        
                        // Manter flags importantes
                        usuario.id = parseInt(usuarioId);
                        usuario.isSystemAdmin = this.usuarios[index].isSystemAdmin || false;
                        usuario.dataCriacao = this.usuarios[index].dataCriacao;
                        usuario.criadoPor = this.usuarios[index].criadoPor;
                        
                        // Atualizar senha apenas se fornecida
                        if (senha) {
                            usuario.senha = senha;
                        } else {
                            usuario.senha = this.usuarios[index].senha;
                        }
                        
                        usuario.ultimaAtualizacao = new Date().toISOString();
                        usuario.atualizadoPor = localStorage.getItem('gestao_equipamentos_usuario') || 'sistema';
                        
                        this.usuarios[index] = usuario;
                        
                        this.mostrarMensagem('Usu치rio atualizado com sucesso!', 'success');
                        this.registrarAtividade('EDITAR_USUARIO', `Editou usu치rio: ${usuario.username}`);
                    }
                } else {
                    // Criar novo usu치rio
                    
                    // Verificar se username j치 existe
                    const usernameExistente = this.usuarios.find(u => 
                        u.username.toLowerCase() === usuario.username.toLowerCase()
                    );
                    if (usernameExistente) {
                        this.mostrarMensagem('Nome de usu치rio j치 existe', 'error');
                        return;
                    }
                    
                    // Verificar se email j치 existe
                    const emailExistente = this.usuarios.find(u => 
                        u.email.toLowerCase() === usuario.email.toLowerCase()
                    );
                    if (emailExistente) {
                        this.mostrarMensagem('E-mail j치 est치 em uso', 'error');
                        return;
                    }
                    
                    usuario.id = this.nextUserId++;
                    usuario.senha = senha;
                    usuario.isSystemAdmin = false; // Apenas o sistema pode criar admins do sistema
                    usuario.dataCriacao = new Date().toISOString().split('T')[0];
                    usuario.criadoPor = localStorage.getItem('gestao_equipamentos_usuario') || 'administrador';
                    usuario.ultimaAtualizacao = new Date().toISOString();
                    usuario.atualizadoPor = localStorage.getItem('gestao_equipamentos_usuario') || 'sistema';
                    
                    this.usuarios.push(usuario);
                    
                    this.mostrarMensagem('Usu치rio criado com sucesso!', 'success');
                    this.registrarAtividade('CRIAR_USUARIO', `Criou usu치rio: ${usuario.username}`);
                }
                
                // Salvar no JSONBin
                const salvou = await this.salvarUsuarios();
                if (salvou) {
                    // Fechar modal e atualizar lista
                    this.fecharModalUsuario();
                    this.renderizarUsuarios();
                    this.atualizarEstatisticas();
                }
            }
            
            abrirModalNovoUsuario() {
                this.usuarioEditando = null;
                const modal = document.getElementById('modal-usuario');
                const titulo = document.getElementById('modal-usuario-titulo');
                const form = document.getElementById('form-usuario');
                
                titulo.querySelector('span').textContent = 'Novo Usu치rio';
                form.reset();
                document.getElementById('usuario-id').value = '';
                document.getElementById('usuario-is-system-admin').value = 'false';
                
                // Resetar valida칞칚o de senha
                document.getElementById('senha-strength-bar').style.width = '0%';
                document.getElementById('senha-strength-text').textContent = 'Fraca';
                document.getElementById('usuario-senha').placeholder = 'M칤nimo 6 caracteres';
                document.getElementById('senha-hint').textContent = 'M칤nimo 6 caracteres';
                
                // Habilitar campos
                document.getElementById('usuario-username').disabled = false;
                document.getElementById('usuario-nivel').disabled = false;
                document.getElementById('usuario-status').disabled = false;
                
                // Senha obrigat칩ria
                document.getElementById('usuario-senha').required = true;
                document.getElementById('usuario-confirmar-senha').required = true;
                document.getElementById('usuario-senha').placeholder = 'M칤nimo 6 caracteres';
                
                modal.classList.add('active');
            }
            
            editarUsuario(id) {
                const usuario = this.usuarios.find(u => u.id === id);
                if (!usuario) return;
                
                this.usuarioEditando = usuario;
                const modal = document.getElementById('modal-usuario');
                const titulo = document.getElementById('modal-usuario-titulo');
                
                titulo.querySelector('span').textContent = 'Editar Usu치rio';
                
                // Preencher formul치rio
                document.getElementById('usuario-id').value = usuario.id;
                document.getElementById('usuario-is-system-admin').value = usuario.isSystemAdmin || false;
                document.getElementById('usuario-username').value = usuario.username;
                document.getElementById('usuario-nome').value = usuario.nome;
                document.getElementById('usuario-email').value = usuario.email;
                document.getElementById('usuario-departamento').value = usuario.departamento || '';
                document.getElementById('usuario-nivel').value = usuario.nivel;
                document.getElementById('usuario-status').value = 
                    (usuario.ativo === true || usuario.ativo === undefined) ? 'ativo' : 'inativo';
                
                // Desabilitar campos para admin do sistema (se n칚o for o pr칩prio admin do sistema editando)
                const isCurrentUserSystemAdmin = this.isCurrentUserSystemAdmin();
                
                if (usuario.isSystemAdmin && !isCurrentUserSystemAdmin) {
                    document.getElementById('usuario-username').disabled = true;
                    document.getElementById('usuario-nivel').disabled = true;
                    document.getElementById('usuario-status').disabled = true;
                    this.mostrarMensagem('Algumas informa칞칫es do administrador do sistema n칚o podem ser alteradas', 'info');
                } else {
                    document.getElementById('usuario-username').disabled = false;
                    document.getElementById('usuario-nivel').disabled = false;
                    document.getElementById('usuario-status').disabled = false;
                }
                
                // Senha em branco (n칚o mostrar a atual por seguran칞a)
                document.getElementById('usuario-senha').value = '';
                document.getElementById('usuario-confirmar-senha').value = '';
                document.getElementById('usuario-senha').placeholder = 'Deixe em branco para n칚o alterar';
                document.getElementById('usuario-senha').required = false;
                document.getElementById('usuario-confirmar-senha').required = false;
                document.getElementById('senha-hint').textContent = 'Deixe em branco para manter a senha atual';
                
                // Resetar for칞a da senha
                document.getElementById('senha-strength-bar').style.width = '0%';
                document.getElementById('senha-strength-text').textContent = 'Fraca';
                
                modal.classList.add('active');
            }
            
            fecharModalUsuario() {
                const modal = document.getElementById('modal-usuario');
                modal.classList.remove('active');
                
                // Resetar valida칞칚o de senha para o padr칚o
                document.getElementById('usuario-senha').required = true;
                document.getElementById('usuario-confirmar-senha').required = true;
                document.getElementById('usuario-senha').placeholder = 'M칤nimo 6 caracteres';
                document.getElementById('senha-hint').textContent = 'M칤nimo 6 caracteres';
                
                // Habilitar campos
                document.getElementById('usuario-username').disabled = false;
                document.getElementById('usuario-nivel').disabled = false;
                document.getElementById('usuario-status').disabled = false;
            }
            
            async excluirUsuario(id) {
                const usuario = this.usuarios.find(u => u.id === id);
                if (!usuario) return;
                
                // Verificar se 칠 admin do sistema
                if (usuario.isSystemAdmin) {
                    this.mostrarMensagem('N칚o 칠 poss칤vel excluir o administrador do sistema', 'error');
                    return;
                }
                
                const confirmar = await this.mostrarConfirmacao(
                    'Confirmar Exclus칚o',
                    `Tem certeza que deseja excluir o usu치rio "${usuario.nome}"?`
                );
                
                if (!confirmar) return;
                
                this.usuarios = this.usuarios.filter(u => u.id !== id);
                const salvou = await this.salvarUsuarios();
                
                if (salvou) {
                    this.mostrarMensagem('Usu치rio exclu칤do com sucesso', 'success');
                    this.registrarAtividade('EXCLUIR_USUARIO', `Excluiu usu치rio: ${usuario.username}`);
                    this.renderizarUsuarios();
                    this.atualizarEstatisticas();
                }
            }
            
            async toggleStatusUsuario(id) {
                const usuario = this.usuarios.find(u => u.id === id);
                if (!usuario) return;
                
                // Verificar se 칠 admin do sistema
                if (usuario.isSystemAdmin) {
                    this.mostrarMensagem('N칚o 칠 poss칤vel desativar o administrador do sistema', 'error');
                    return;
                }
                
                const isAtivo = usuario.ativo === true || usuario.ativo === undefined;
                const acao = isAtivo ? 'desativar' : 'ativar';
                
                const confirmar = await this.mostrarConfirmacao(
                    `Confirmar ${acao === 'desativar' ? 'Desativa칞칚o' : 'Ativa칞칚o'}`,
                    `Tem certeza que deseja ${acao} o usu치rio "${usuario.nome}"?`
                );
                
                if (!confirmar) return;
                
                usuario.ativo = !isAtivo;
                usuario.ultimaAtualizacao = new Date().toISOString();
                usuario.atualizadoPor = localStorage.getItem('gestao_equipamentos_usuario') || 'sistema';
                
                const salvou = await this.salvarUsuarios();
                
                if (salvou) {
                    this.mostrarMensagem(
                        `Usu치rio ${acao === 'desativar' ? 'desativado' : 'ativado'} com sucesso`,
                        'success'
                    );
                    this.registrarAtividade('ALTERAR_STATUS_USUARIO', `${acao} usu치rio: ${usuario.username}`);
                    this.renderizarUsuarios();
                    this.atualizarEstatisticas();
                }
            }
            
            // ========== FUN칂칏ES DE VALIDA칂츾O ==========
            
            validarEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(String(email).toLowerCase());
            }
            
            validarForcaSenha(senha) {
                const forca = {
                    pontos: 0,
                    nivel: 'fraca'
                };
                
                if (!senha) {
                    this.atualizarForcaSenhaUI(0, 'Fraca', '#e74c3c');
                    return forca;
                }
                
                // Verificar comprimento
                if (senha.length >= 6) forca.pontos++;
                if (senha.length >= 8) forca.pontos++;
                if (senha.length >= 12) forca.pontos++;
                
                // Verificar caracteres
                if (/[A-Z]/.test(senha)) forca.pontos++;
                if (/[a-z]/.test(senha)) forca.pontos++;
                if (/[0-9]/.test(senha)) forca.pontos++;
                if (/[^A-Za-z0-9]/.test(senha)) forca.pontos++;
                
                // Determinar n칤vel
                if (forca.pontos <= 2) forca.nivel = 'fraca';
                else if (forca.pontos <= 4) forca.nivel = 'm칠dia';
                else if (forca.pontos <= 6) forca.nivel = 'forte';
                else forca.nivel = 'muito forte';
                
                // Cores baseadas na for칞a
                let cor = '#e74c3c';
                if (forca.nivel === 'm칠dia') cor = '#f39c12';
                else if (forca.nivel === 'forte') cor = '#2ecc71';
                else if (forca.nivel === 'muito forte') cor = '#27ae60';
                
                const porcentagem = (forca.pontos / 7) * 100;
                this.atualizarForcaSenhaUI(porcentagem, forca.nivel, cor);
                
                return forca;
            }
            
            atualizarForcaSenhaUI(porcentagem, texto, cor) {
                const bar = document.getElementById('senha-strength-bar');
                const text = document.getElementById('senha-strength-text');
                
                if (bar && text) {
                    bar.style.width = `${porcentagem}%`;
                    bar.style.backgroundColor = cor;
                    text.textContent = texto.charAt(0).toUpperCase() + texto.slice(1);
                }
            }
            
            validarConfirmacaoSenha() {
                const senha = document.getElementById('usuario-senha').value;
                const confirmar = document.getElementById('usuario-confirmar-senha').value;
                const confirmarInput = document.getElementById('usuario-confirmar-senha');
                
                if (confirmar && senha !== confirmar) {
                    confirmarInput.style.borderColor = '#e74c3c';
                } else if (confirmar && senha === confirmar) {
                    confirmarInput.style.borderColor = '#2ecc71';
                } else {
                    confirmarInput.style.borderColor = '';
                }
            }
            
            // ========== FUN칂칏ES AUXILIARES ==========
            
            getNivelInfo(nivelKey) {
                const niveis = {
                    'operador': { nome: 'Operador', icone: 'fa-user', cor: '#3498db' },
                    'supervisor': { nome: 'Supervisor', icone: 'fa-user-tie', cor: '#f39c12' },
                    'manutencao': { nome: 'Manuten칞칚o', icone: 'fa-tools', cor: '#9b59b6' },
                    'engenharia': { nome: 'Engenharia', icone: 'fa-user-cog', cor: '#2ecc71' },
                    'administrador': { nome: 'Administrador', icone: 'fa-user-shield', cor: '#e74c3c' }
                };
                
                return niveis[nivelKey] || { nome: nivelKey, icone: 'fa-user', cor: '#95a5a6' };
            }
            
            isCurrentUserSystemAdmin() {
                return localStorage.getItem('gestao_equipamentos_is_system_admin') === 'true';
            }
            
            formatarData(dataString) {
                if (!dataString) return 'N칚o informada';
                try {
                    const data = new Date(dataString);
                    return data.toLocaleDateString('pt-BR');
                } catch (e) {
                    return dataString;
                }
            }
            
            formatarDataHora(dataString) {
                if (!dataString) return 'N칚o informada';
                try {
                    const data = new Date(dataString);
                    return data.toLocaleDateString('pt-BR') + ' ' + 
                           data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                } catch (e) {
                    return dataString;
                }
            }
            
            escapeHTML(texto) {
                if (!texto) return '';
                const div = document.createElement('div');
                div.textContent = texto;
                return div.innerHTML;
            }
            
            // ========== FUN칂칏ES DE INTERFACE ==========
            
            mostrarLoading(mostrar) {
                const container = document.getElementById('usuarios-container');
                if (mostrar) {
                    container.innerHTML = `
                        <div class="loading">
                            <i class="fas fa-cog fa-spin"></i>
                            <p>Carregando usu치rios...</p>
                        </div>
                    `;
                }
            }
            
            mostrarMensagem(texto, tipo = 'info') {
                // Remover mensagem anterior
                const mensagemAnterior = document.querySelector('.mensagem-flutuante');
                if (mensagemAnterior) {
                    mensagemAnterior.remove();
                }
                
                // Criar nova mensagem
                const mensagem = document.createElement('div');
                mensagem.className = `mensagem-flutuante ${tipo}`;
                
                const icones = {
                    success: 'check-circle',
                    error: 'exclamation-circle',
                    warning: 'exclamation-triangle',
                    info: 'info-circle'
                };
                
                mensagem.innerHTML = `
                    <div class="mensagem-conteudo">
                        <i class="fas fa-${icones[tipo] || 'info-circle'}"></i>
                        <span>${texto}</span>
                    </div>
                `;
                
                document.body.appendChild(mensagem);
                
                setTimeout(() => {
                    mensagem.classList.add('show');
                }, 10);
                
                setTimeout(() => {
                    mensagem.classList.remove('show');
                    setTimeout(() => mensagem.remove(), 300);
                }, 5000);
            }
            
            mostrarConfirmacao(titulo, mensagem) {
                return new Promise((resolve) => {
                    const modal = document.getElementById('modal-confirmacao');
                    document.getElementById('modal-confirmacao-titulo').innerHTML = 
                        `<i class="fas fa-question-circle"></i> ${titulo}`;
                    document.getElementById('modal-confirmacao-mensagem').textContent = mensagem;
                    
                    const confirmarBtn = document.getElementById('modal-confirmacao-confirmar');
                    
                    const handleConfirmar = () => {
                        this.fecharModalConfirmacao();
                        resolve(true);
                    };
                    
                    const handleCancelar = () => {
                        this.fecharModalConfirmacao();
                        resolve(false);
                    };
                    
                    // Remover eventos anteriores
                    confirmarBtn.replaceWith(confirmarBtn.cloneNode(true));
                    const novoConfirmarBtn = document.getElementById('modal-confirmacao-confirmar');
                    
                    novoConfirmarBtn.addEventListener('click', handleConfirmar);
                    
                    this.modalConfirmacaoCallback = {
                        confirmar: handleConfirmar,
                        cancelar: handleCancelar
                    };
                    
                    modal.classList.add('active');
                    
                    // Fechar ao clicar no X
                    const closeBtn = modal.querySelector('.close-modal');
                    closeBtn.onclick = handleCancelar;
                    
                    // Fechar ao clicar fora
                    modal.onclick = (e) => {
                        if (e.target === modal) handleCancelar();
                    };
                });
            }
            
            fecharModalConfirmacao() {
                const modal = document.getElementById('modal-confirmacao');
                modal.classList.remove('active');
                this.modalConfirmacaoCallback = null;
            }
            
            aplicarFiltros() {
                // Filtros j치 s칚o aplicados automaticamente via eventos
                this.mostrarMensagem('Filtros aplicados', 'info');
            }
            
            async exportarUsuarios() {
                try {
                    let csv = 'ID,Usu치rio,Nome,E-mail,Departamento,N칤vel de Acesso,Status,Data Cria칞칚o,Admin Sistema,칔ltimo Acesso\n';
                    
                    this.usuarios.forEach(usuario => {
                        const escapeCSV = (str) => {
                            if (str === null || str === undefined) return '';
                            const string = String(str);
                            if (string.includes(',') || string.includes('"') || string.includes('\n')) {
                                return `"${string.replace(/"/g, '""')}"`;
                            }
                            return string;
                        };
                        
                        const isAtivo = usuario.ativo === true || usuario.ativo === undefined;
                        const nivelInfo = this.getNivelInfo(usuario.nivel);
                        const ultimoAcesso = usuario.ultimoAcesso ? this.formatarDataHora(usuario.ultimoAcesso) : '';
                        
                        csv += [
                            usuario.id,
                            escapeCSV(usuario.username),
                            escapeCSV(usuario.nome),
                            escapeCSV(usuario.email || ''),
                            escapeCSV(usuario.departamento || ''),
                            escapeCSV(nivelInfo.nome),
                            isAtivo ? 'Ativo' : 'Inativo',
                            usuario.dataCriacao || '',
                            usuario.isSystemAdmin ? 'Sim' : 'N칚o',
                            ultimoAcesso
                        ].join(',') + '\n';
                    });
                    
                    // Criar e baixar arquivo
                    const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    
                    link.href = URL.createObjectURL(blob);
                    link.download = `usuarios_${new Date().toISOString().split('T')[0]}.csv`;
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    this.mostrarMensagem('Lista de usu치rios exportada com sucesso', 'success');
                    this.registrarAtividade('EXPORTAR_USUARIOS', `Exportou ${this.usuarios.length} usu치rios`);
                    
                } catch (error) {
                    console.error('Erro ao exportar usu치rios:', error);
                    this.mostrarMensagem('Erro ao exportar lista', 'error');
                }
            }
            
            reenviarSenhas() {
                this.mostrarMensagem('Funcionalidade em desenvolvimento', 'info');
            }
            
            registrarAtividade(acao, detalhes) {
                if (window.registrarAtividade) {
                    window.registrarAtividade(acao, detalhes);
                } else {
                    console.log(`[${acao}] ${detalhes}`);
                }
            }
        }
        
        // ===========================================
        // INICIALIZA칂츾O
        // ===========================================
        
        let gerenciador;
        
        document.addEventListener('DOMContentLoaded', () => {
            gerenciador = new GerenciadorUsuarios();
            window.gerenciador = gerenciador;
        });
        
        // Fun칞칫es globais para compatibilidade
        function abrirModalNovoUsuario() {
            gerenciador?.abrirModalNovoUsuario();
        }
        
        function fecharModalUsuario() {
            gerenciador?.fecharModalUsuario();
        }
        
        function aplicarFiltros() {
            gerenciador?.aplicarFiltros();
        }
        
        function exportarUsuarios() {
            gerenciador?.exportarUsuarios();
        }
        
        function reenviarSenhas() {
            gerenciador?.reenviarSenhas();
        }
        
        // ===========================================
        // SEGURAN칂A ADICIONAL
        // ===========================================
        
        // Proteger contra c칩pia de texto sens칤vel
        document.addEventListener('copy', function(e) {
            if (e.target.tagName === 'INPUT' && e.target.type === 'password') {
                e.preventDefault();
                return false;
            }
        });
        
        // Prevenir inspe칞칚o de elementos sens칤veis
        document.addEventListener('contextmenu', function(e) {
            if (e.target.closest('.usuario-card')) {
                e.preventDefault();
                return false;
            }
        });
    </script>
</body>
</html>
